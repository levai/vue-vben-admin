---
name: 操作日志管理系统设计
overview: 设计并实现一个完整的操作日志管理系统，采用后端AOP切面自动记录所有API请求，包括数据库设计、后端拦截器、定时清理任务和前端管理页面。
todos:
  - id: "1"
    content: 设计并创建数据库表结构 sys_operation_log
    status: completed
  - id: "2"
    content: 实现后端实体类、DTO、VO（SysOperationLog, OperationLogDTO, OperationLogQueryDTO, OperationLogVO）
    status: completed
  - id: "3"
    content: 实现后端Service和Mapper（OperationLogService, OperationLogMapper）
    status: completed
  - id: "4"
    content: 实现后端AOP切面自动记录API请求（OperationLogAspect）
    status: completed
  - id: "5"
    content: 实现后端Controller API（SystemOperationLogController）
    status: completed
  - id: "6"
    content: 实现定时任务清理3个月前的日志（ScheduledTask）
    status: completed
  - id: "7"
    content: 实现前端API定义（operation-log.ts）
    status: completed
  - id: "8"
    content: 实现日志管理页面（list.vue, data.ts）
    status: completed
  - id: "9"
    content: 配置路由、权限码和国际化
    status: completed
  - id: "10"
    content: 测试验证完整功能
    status: completed
---

# 操作日志管理系统设计方案

## 一、系统架构设计

### 1.1 整体流程

```
用户操作 → 前端API请求 → 后端AOP切面拦截 → 自动记录日志 → 数据库存储
                                                      ↓
前端管理页面 ← 日志查询API ← 日志数据
定时清理任务 → 删除3个月前的日志
```

### 1.2 核心组件

- **后端AOP切面**：自动拦截所有Controller方法，记录操作日志
- **日志服务**：处理日志的存储、查询、删除
- **定时清理任务**：定期清理3个月前的日志
- **前端管理页面**：查看、筛选、统计日志

## 二、数据库设计

### 2.1 操作日志表 (sys_operation_log)

**表结构**：

```sql
CREATE TABLE IF NOT EXISTS `sys_operation_log` (
    `id` VARCHAR(64) NOT NULL COMMENT '日志ID',
    `user_id` VARCHAR(64) NOT NULL COMMENT '用户ID',
    `username` VARCHAR(50) NOT NULL COMMENT '用户名',
    `real_name` VARCHAR(50) DEFAULT NULL COMMENT '真实姓名',
    `operation_type` VARCHAR(20) NOT NULL COMMENT '操作类型：view/add/edit/delete/export/import/login/logout/download/upload',
    `operation_module` VARCHAR(50) DEFAULT NULL COMMENT '操作模块：system/user/menu/dept/role等',
    `operation_page` VARCHAR(200) DEFAULT NULL COMMENT '操作页面路径',
    `page_name` VARCHAR(100) DEFAULT NULL COMMENT '页面名称（从菜单表查询）',
    `request_method` VARCHAR(10) DEFAULT NULL COMMENT '请求方法：GET/POST/PUT/DELETE',
    `request_url` VARCHAR(500) DEFAULT NULL COMMENT '请求URL',
    `request_params` TEXT DEFAULT NULL COMMENT '请求参数（JSON格式）',
    `response_code` INT DEFAULT NULL COMMENT '响应状态码',
    `response_data` TEXT DEFAULT NULL COMMENT '响应数据（JSON格式，可选）',
    `ip_address` VARCHAR(50) DEFAULT NULL COMMENT 'IP地址',
    `user_agent` VARCHAR(500) DEFAULT NULL COMMENT '用户代理（浏览器信息）',
    `browser` VARCHAR(50) DEFAULT NULL COMMENT '浏览器类型',
    `os` VARCHAR(50) DEFAULT NULL COMMENT '操作系统',
    `duration` INT DEFAULT NULL COMMENT '操作耗时（毫秒）',
    `status` INT DEFAULT 1 COMMENT '状态：0-失败，1-成功',
    `error_message` TEXT DEFAULT NULL COMMENT '错误信息',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    KEY `idx_user_id` (`user_id`),
    KEY `idx_operation_type` (`operation_type`),
    KEY `idx_operation_module` (`operation_module`),
    KEY `idx_create_time` (`create_time`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='操作日志表';
```

**注意**：
- ✅ 使用 `utf8mb4` 字符集，支持完整的 UTF-8 字符（包括 emoji）
- ✅ 操作日志表不支持逻辑删除（历史记录需要完整保留）
- ✅ 自动时间戳：`create_time` 使用 `DEFAULT CURRENT_TIMESTAMP`
- ✅ 新增字段：`page_name` - 页面名称（从菜单表查询）

**操作类型枚举**：

- `view` - 查看/查询
- `add` - 新增
- `edit` - 编辑
- `delete` - 删除
- `export` - 导出
- `import` - 导入
- `login` - 登录
- `logout` - 登出
- `download` - 下载
- `upload` - 上传

## 三、后端实现

### 3.1 实体类 (SysOperationLog.java)

**文件位置**：`apps/backend-service/src/main/java/com/vben/admin/model/entity/SysOperationLog.java`

**核心字段**：

- id, userId, username, realName
- operationType, operationModule, operationPage, operationTitle
- requestMethod, requestUrl, requestParams, responseCode, responseData
- ipAddress, userAgent, browser, os
- duration, status, errorMessage
- createTime

### 3.2 DTO 和 VO

**DTO**：

- `OperationLogDTO.java` - 创建日志的DTO
- `OperationLogQueryDTO.java` - 查询日志的DTO（支持分页、筛选）

**VO**：

- `OperationLogVO.java` - 返回给前端的VO

### 3.3 Controller (OperationLogController.java)

**文件位置**：`apps/backend-service/src/main/java/com/vben/admin/controller/OperationLogController.java`

**API接口**：

- `GET /system/operation-log` - 获取日志列表（分页、筛选）✅
- `GET /system/operation-log/{id}` - 获取日志详情 ✅
- `DELETE /system/operation-log/{id}` - 删除日志 ✅
- `DELETE /system/operation-log/batch` - 批量删除日志 ✅
- `GET /system/operation-log/modules` - 获取操作模块列表（用于下拉选项）✅
- `GET /system/operation-log/types` - 获取操作类型列表（用于下拉选项）✅

**注意**：操作日志由 AOP 切面自动记录，无需手动创建接口。

**查询参数**（OperationLogQueryDTO）：

- page, pageSize - 分页
- userId, username - 用户筛选
- operationType - 操作类型筛选
- operationModule - 模块筛选
- status - 状态筛选（0-失败，1-成功）
- startTime, endTime - 时间范围（格式：yyyy-MM-dd）
- keyword - 关键词搜索（操作标题、请求URL）

### 3.4 Service 和 Mapper

**Service**：

- `OperationLogService.java` - 日志业务逻辑
- 支持批量插入（提高性能）
- 支持日志清理（定时任务）

**Mapper**：

- `OperationLogMapper.java` - MyBatis Mapper接口

## 四、后端AOP切面实现（核心）

### 4.1 AOP切面 (OperationLogAspect.java)

**文件位置**：`apps/backend-service/src/main/java/com/vben/admin/core/aspect/OperationLogAspect.java`

**核心功能**：

- 使用 `@Around` 拦截所有 `@RestController` 的方法
- 自动提取请求信息（URL、方法、参数、响应）
- 从 SecurityContext 和 Request 中获取用户信息
- 解析 User-Agent 获取浏览器和操作系统信息
- 计算请求耗时
- 异步保存日志（避免影响主业务性能）

**实现要点**：

```java
@Aspect
@Component
@Slf4j
@RequiredArgsConstructor
public class OperationLogAspect {

    private final OperationLogService operationLogService;

    @Around("@within(org.springframework.web.bind.annotation.RestController)")
    public Object around(ProceedingJoinPoint joinPoint) throws Throwable {
        // 1. 获取请求信息
        HttpServletRequest request = getRequest();
        String requestMethod = request.getMethod();
        String requestUrl = request.getRequestURI();
        String requestParams = getRequestParams(joinPoint, request);

        // 2. 获取用户信息
        String userId = SecurityUtils.getCurrentUserId();
        String username = SecurityUtils.getCurrentUsername();

        // 3. 获取IP和浏览器信息
        String ipAddress = getIpAddress(request);
        String userAgent = request.getHeader("User-Agent");
        BrowserInfo browserInfo = parseUserAgent(userAgent);

        // 4. 记录开始时间
        long startTime = System.currentTimeMillis();

        // 5. 执行方法
        Object result = null;
        int status = 1; // 成功
        String errorMessage = null;
        String responseData = null;
        try {
            result = joinPoint.proceed();
            responseData = getResponseData(result);
        } catch (Exception e) {
            status = 0; // 失败
            errorMessage = e.getMessage();
            throw e;
        } finally {
            // 6. 计算耗时
            long duration = System.currentTimeMillis() - startTime;

            // 7. 解析操作信息（从URL和方法推断）
            OperationInfo operationInfo = parseOperationInfo(requestUrl, requestMethod);

            // 8. 异步保存日志
            saveLogAsync(userId, username, operationInfo, requestMethod,
                        requestUrl, requestParams, responseData, ipAddress,
                        userAgent, browserInfo, duration, status, errorMessage);
        }

        return result;
    }
}
```

### 4.2 操作信息解析

**根据URL和方法自动推断操作类型和模块**：

- `/system/user/list` + `GET` → 操作类型：`view`，模块：`system`，标题：`查看用户列表`
- `/system/user` + `POST` → 操作类型：`add`，模块：`system`，标题：`新增用户`
- `/system/user/{id}` + `PUT` → 操作类型：`edit`，模块：`system`，标题：`编辑用户`
- `/system/user/{id}` + `DELETE` → 操作类型：`delete`，模块：`system`，标题：`删除用户`

**实现工具类**：`OperationInfoParser.java`

### 4.3 浏览器信息解析

**工具类**：`BrowserInfoParser.java`

- 解析 User-Agent 获取浏览器类型（Chrome、Firefox、Safari等）
- 解析操作系统（Windows、Mac、Linux等）

### 4.4 敏感信息过滤

**工具类**：`SensitiveDataFilter.java`

- 过滤密码字段（password、pwd、passwd）
- 过滤敏感参数（token、secret、key）
- 限制日志内容长度（避免过大）

### 4.5 前端API定义 ✅

**文件位置**：`apps/web-antd/src/api/system/operation-log.ts`

**API函数**：

- ✅ `getOperationLogList(params)` - 获取日志列表（分页、筛选）
- ✅ `getOperationLogDetail(id)` - 获取日志详情
- ✅ `deleteOperationLog(id)` - 删除日志
- ✅ `batchDeleteOperationLog(ids[])` - 批量删除
- ✅ `getOperationModuleList(search?)` - 获取操作模块列表（用于下拉选项）
- ✅ `getOperationTypeList(search?)` - 获取操作类型列表（用于下拉选项）

### 4.6 日志管理页面 ✅

**文件位置**：`apps/web-antd/src/views/system/operation-log/list.vue`

**功能**：

- ✅ 日志列表展示（使用 `useVbenVxeGrid`）
- ✅ 筛选条件：
  - 用户（下拉选择，支持用户名/真实姓名搜索）
  - 操作类型（下拉选择：view/add/edit/delete等）
  - 操作模块（下拉选择：system/user/menu等）
  - 状态（成功/失败）
  - 时间范围（日期选择器）
  - 关键词搜索（操作标题、请求URL）
- ✅ 日志详情查看（Drawer，显示完整信息包括请求参数、响应数据）
- ✅ 批量删除
- ✅ 操作按钮权限控制（使用 `usePermissions` hook）

**表格列**：

- ✅ 操作时间
- ✅ 用户（用户名/真实姓名）
- ✅ 操作类型（标签显示，不同颜色）
- ✅ 操作模块
- ✅ 操作标题
- ✅ 请求方法（GET/POST/PUT/DELETE）
- ✅ 请求URL
- ✅ IP地址
- ✅ 浏览器/操作系统
- ✅ 状态（成功/失败，带颜色标识）
- ✅ 操作耗时（ms）
- ✅ 操作（查看详情、删除）

### 4.7 路由配置 ✅

**文件位置**：`apps/web-antd/src/router/routes/modules/system.ts`

**已添加路由**：

```typescript
{
  path: '/system/operation-log',
  name: 'SystemOperationLog',
  meta: {
    icon: 'mdi:file-document-outline',
    title: $t('system.operationLog.title'),
  },
  component: () => import('#/views/system/operation-log/list.vue'),
}
```

**注意**：路由权限由后端菜单控制（后端模式），无需在路由 meta 中配置 `authority`。

### 4.8 权限码定义 ✅

**文件位置**：`apps/web-antd/src/constants/permission-codes.ts`

**已添加权限码**：

```typescript
OPERATION_LOG: {
  VIEW: 'ac:system:operation-log:view',
  DELETE: 'ac:system:operation-log:delete',
}
```

**注意**：权限码已在数据库 `sys_permission` 表中定义，并在菜单数据中关联。

### 4.9 国际化配置 ✅

**文件位置**：

- ✅ `apps/web-antd/src/locales/langs/zh-CN/system.json`
- ✅ `apps/web-antd/src/locales/langs/en-US/system.json`

**已添加翻译**：

```json
{
  "operationLog": {
    "title": "操作日志",
    "name": "操作日志",
    "operationType": "操作类型",
    "operationModule": "操作模块",
    "operationPage": "操作页面",
    "operationTitle": "操作标题",
    "requestMethod": "请求方法",
    "requestUrl": "请求URL",
    "ipAddress": "IP地址",
    "userAgent": "用户代理",
    "duration": "耗时(ms)",
    "status": "状态",
    "success": "成功",
    "failed": "失败"
  }
}
```

## 五、技术实现细节

### 5.1 后端AOP切面实现细节 ✅

**拦截范围**：

- ✅ 拦截所有 `@RestController` 的方法
- ✅ 排除路径：`/actuator`、`/doc.html`、`/swagger`、`/v3/api-docs`、`/favicon.ico`
- ✅ 登录和登出接口需要记录（已过滤敏感信息）

**异步处理**：

- ✅ 使用 `@Async("operationLogExecutor")` 异步保存日志
- ✅ 配置线程池（`AsyncConfig` 中配置 `operationLogExecutor`）
- ✅ 异常处理：日志保存失败不影响主业务（catch 异常并记录日志）

**性能优化**：

- ✅ 使用线程池异步处理
- ✅ 敏感信息过滤减少存储空间
- ✅ 限制日志内容长度（requestParams、responseData 最多5000字符）

### 5.2 后端性能优化 ✅

**异步处理**：

- ✅ 使用线程池异步保存日志（`operationLogExecutor`）
- ✅ 避免阻塞主业务线程

**索引优化**：

- ✅ 为常用查询字段建立索引：
  - `idx_user_id` - 用户ID索引
  - `idx_operation_type` - 操作类型索引
  - `idx_operation_module` - 操作模块索引
  - `idx_create_time` - 创建时间索引
  - `idx_status` - 状态索引

**日志清理**：

- ✅ 定时任务每天凌晨2点执行（`@Scheduled(cron = "0 0 2 * * ?")`）
- ✅ 删除3个月前的日志（`LocalDateTime.now().minusMonths(3)`）
- ✅ 使用批量删除提高性能
- ✅ 记录清理日志数量（INFO 级别日志）

### 5.3 配置说明

**数据库配置**：

- ✅ 统一使用 `spring.datasource.url` 路径（`application.yml` 和 `application-dev.yml` 保持一致）
- ✅ 字符编码：UTF-8（`characterEncoding=UTF-8`）
- ✅ 时区设置：`Asia/Shanghai`

**定时任务配置**：

- ✅ 启动类已添加 `@EnableScheduling` 注解
- ✅ 清理任务：每天凌晨2点执行（`OperationLogCleanupTask`）

**异步任务配置**：

- ✅ 线程池配置：`AsyncConfig` 中配置 `operationLogExecutor`
- ✅ 核心线程数、最大线程数、队列容量等参数可调整

### 5.4 安全性考虑 ✅

**敏感信息过滤**：

- ✅ 过滤密码字段（password、pwd、passwd）
- ✅ 过滤敏感参数（token、secret、key、accessToken、refreshToken）
- ✅ 限制日志内容长度（requestParams、responseData 最多5000字符）
- ✅ 敏感字段替换为 `***`（`SensitiveDataFilter` 工具类）

**权限控制**：

- ✅ 使用权限码控制访问：`ac:system:operation-log:view`、`ac:system:operation-log:delete`
- ✅ 前端使用 `v-access:code` 指令控制按钮显示
- ✅ 后端接口需要认证（Spring Security）

**数据安全**：

- ✅ 日志数据不加密存储（便于查询和分析）
- ✅ 定期清理过期日志（3个月前的日志自动删除）
- ✅ 敏感信息已过滤，不会记录密码等敏感数据

## 六、文件清单

### 后端文件 ✅

1. ✅ `apps/backend-service/src/main/java/com/vben/admin/model/entity/SysOperationLog.java` - 实体类
2. ✅ `apps/backend-service/src/main/java/com/vben/admin/model/dto/OperationLogQueryDTO.java` - 查询DTO
3. ✅ `apps/backend-service/src/main/java/com/vben/admin/model/vo/OperationLogVO.java` - 视图对象
4. ✅ `apps/backend-service/src/main/java/com/vben/admin/controller/OperationLogController.java` - Controller
5. ✅ `apps/backend-service/src/main/java/com/vben/admin/service/OperationLogService.java` - Service接口
6. ✅ `apps/backend-service/src/main/java/com/vben/admin/service/impl/OperationLogServiceImpl.java` - Service实现
7. ✅ `apps/backend-service/src/main/java/com/vben/admin/mapper/OperationLogMapper.java` - Mapper接口
8. ✅ `apps/backend-service/src/main/java/com/vben/admin/core/aspect/OperationLogAspect.java` - AOP切面（核心）
9. ✅ `apps/backend-service/src/main/java/com/vben/admin/core/utils/OperationInfoParser.java` - 操作信息解析工具
10. ✅ `apps/backend-service/src/main/java/com/vben/admin/core/utils/BrowserInfoParser.java` - 浏览器信息解析工具
11. ✅ `apps/backend-service/src/main/java/com/vben/admin/core/utils/SensitiveDataFilter.java` - 敏感信息过滤工具
12. ✅ `apps/backend-service/src/main/java/com/vben/admin/core/utils/MenuModuleResolver.java` - 菜单模块解析工具
13. ✅ `apps/backend-service/src/main/java/com/vben/admin/core/task/OperationLogCleanupTask.java` - 定时清理任务
14. ✅ `apps/backend-service/src/main/resources/db/modules/operation-log/operation-log-schema.sql` - 表结构
15. ✅ `apps/backend-service/src/main/java/com/vben/admin/BackendServiceApplication.java` - 启动类（已添加@EnableScheduling）

### 前端文件 ✅

1. ✅ `apps/web-antd/src/api/system/operation-log.ts` - API定义
2. ✅ `apps/web-antd/src/views/system/operation-log/list.vue` - 日志列表页面
3. ✅ `apps/web-antd/src/views/system/operation-log/data.ts` - 表格列定义
4. ✅ `apps/web-antd/src/views/system/operation-log/modules/detail.vue` - 日志详情抽屉组件
5. ✅ `apps/web-antd/src/router/routes/modules/system.ts` - 路由配置（已添加）
6. ✅ `apps/web-antd/src/constants/permission-codes.ts` - 权限码（已添加）
7. ✅ `apps/web-antd/src/locales/langs/zh-CN/system.json` - 中文翻译（已添加）
8. ✅ `apps/web-antd/src/locales/langs/en-US/system.json` - 英文翻译（已添加）

### 数据库文件 ✅

1. ✅ `apps/backend-service/src/main/resources/db/modules/operation-log/operation-log-schema.sql` - 表结构
2. ✅ `apps/backend-service/src/main/resources/db/modules/operation-log/operation-log-data.sql` - 初始数据（空文件，操作日志无需初始数据）

## 七、实施步骤 ✅

1. ✅ **数据库设计**：创建操作日志表（sys_operation_log）
2. ✅ **后端实体和DTO**：创建实体类、DTO、VO
3. ✅ **后端工具类**：实现操作信息解析、浏览器信息解析、敏感信息过滤、菜单模块解析
4. ✅ **后端AOP切面**：实现自动记录所有API请求的切面（核心）
5. ✅ **后端Service和Mapper**：实现日志的存储、查询、删除业务逻辑
6. ✅ **后端定时任务**：实现清理3个月前的日志任务（每天凌晨2点执行）
7. ✅ **后端Controller**：实现日志查询和管理的API
8. ✅ **前端API定义**：定义API接口
9. ✅ **前端管理页面**：实现日志列表和详情页面
10. ✅ **路由和权限配置**：添加路由和权限码
11. ✅ **国际化配置**：添加翻译
12. ✅ **测试验证**：测试自动记录、查询、删除、定时清理等功能

**状态**：✅ 所有功能已完成并测试通过

## 八、扩展功能（可选）

1. **日志统计图表**：操作类型分布、用户操作排行、模块访问统计
2. **日志导出**：导出Excel、CSV格式
3. **日志告警**：异常操作告警（如频繁删除、异常IP等）
4. **日志分析**：操作热力图、用户行为分析
5. **日志归档**：定期归档到历史表或文件系统
