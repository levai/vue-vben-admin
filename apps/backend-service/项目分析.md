# Vben Admin 后端服务项目分析

## 📋 技术栈

### 核心框架

- **Spring Boot**: 2.7.18
- **Java**: 11
- **构建工具**: Maven 3.6+

### 数据层

- **数据库**: MySQL 8.0+
- **ORM**: MyBatis Plus 3.5.9
  - 分页插件：`PaginationInnerInterceptor`
  - 逻辑删除：`@TableLogic`
  - 自动填充：`FieldFillHandler`
- **连接池**: Druid 1.2.16
  - 监控统计
  - SQL 防火墙
  - 连接池管理

### 安全认证

- **Spring Security**: 2.7.18
  - JWT 认证过滤器
  - 无状态 Session（STATELESS）
  - 自定义认证入口点和拒绝处理器
- **JWT**: jjwt 0.7.0
  - AccessToken（2小时）
  - RefreshToken（7天）
  - HS512 签名算法

### API 文档

- **Knife4j**: 3.0.3（基于 Swagger 3.0）
  - 在线 API 文档
  - 接口测试

### 工具库

- **Lombok**: 1.18.32
  - `@Data`、`@RequiredArgsConstructor`、`@Slf4j`
- **Hutool**: 5.8.26
  - Java 工具类库
- **Apache Commons Lang3**
  - 字符串工具类

### 其他

- **JAXB API**: 2.3.1（Java 11+ 需要）
- **Spring Boot Validation**: 参数校验

---

## 🎨 编码风格

### 1. 项目结构（分层架构）

```
com.vben.admin/
├── BackendServiceApplication.java    # 启动类
├── config/                           # 配置层
│   ├── SecurityConfiguration.java   # Spring Security 配置
│   ├── MybatisPlusConfig.java      # MyBatis Plus 配置
│   ├── Knife4jConfig.java           # Swagger 配置
│   ├── CorsConfig.java              # 跨域配置
│   └── FieldFillHandler.java       # 字段自动填充
├── controller/                       # 控制层（RESTful API）
├── service/                          # 服务层
│   └── impl/                        # 服务实现
├── mapper/                          # 数据访问层（MyBatis）
├── model/                           # 数据模型层
│   ├── entity/                     # 实体类（数据库表映射）
│   ├── dto/                        # 数据传输对象（请求参数）
│   └── vo/                         # 视图对象（响应数据）
└── core/                            # 核心功能
    ├── enums/                      # 枚举类
    ├── exception/                  # 异常处理
    ├── filter/                     # 过滤器
    ├── model/                      # 通用模型（BaseResult、PageResult）
    └── utils/                       # 工具类
```

### 2. 命名规范

#### 类命名

- **Controller**: `*Controller`（如 `AuthController`、`SystemRoleController`）
- **Service**: `*Service`（接口）、`*ServiceImpl`（实现）
- **Mapper**: `*Mapper`（如 `UserMapper`、`RoleMapper`）
- **Entity**: `Sys*`（如 `SysUser`、`SysRole`）
- **DTO**: `*DTO`（如 `LoginDTO`、`RoleDTO`）
- **VO**: `*VO`（如 `UserVO`、`RoleVO`）

#### 方法命名

- **Controller**: RESTful 风格
  - `get*` - GET 请求
  - `create*` - POST 请求
  - `update*` - PUT 请求
  - `delete*` - DELETE 请求
- **Service**: 业务语义
  - `login()` - 登录
  - `getRoleList()` - 获取角色列表
  - `createRole()` - 创建角色

#### 变量命名

- 使用 camelCase（驼峰命名）
- 布尔值使用 `is*` 前缀（如 `isTreeExpanded`）

### 3. 注解使用

#### 常用注解

- **Lombok**:
  - `@Data` - 自动生成 getter/setter/toString/equals/hashCode
  - `@RequiredArgsConstructor` - 生成 final 字段的构造函数
  - `@Slf4j` - 自动生成 log 对象
- **Spring**:
  - `@RestController` - RESTful 控制器
  - `@Service` - 服务层
  - `@RequiredArgsConstructor` - 依赖注入（替代 `@Autowired`）
  - `@Transactional` - 事务管理
- **MyBatis Plus**:
  - `@TableName` - 表名映射
  - `@TableId` - 主键
  - `@TableLogic` - 逻辑删除
  - `@TableField` - 字段映射
- **Validation**:
  - `@Valid` - 参数校验
  - `@Validated` - 分组校验
  - `@NotBlank` - 非空校验

### 4. 代码风格特点

#### 依赖注入

- **优先使用构造函数注入**（`@RequiredArgsConstructor`）
- 避免使用 `@Autowired` 字段注入

#### 异常处理

- **统一异常处理**: `@RestControllerAdvice` + `GlobalExceptionHandler`
- **自定义业务异常**: `BusinessException`
- **HTTP 状态码映射**:
  - 400 - 参数错误
  - 401 - 未认证
  - 403 - 无权限
  - 404 - 资源不存在
  - 500 - 服务器错误

#### 响应格式

- **统一响应结构**: `BaseResult<T>`
  ```java
  {
    "code": 0,
    "data": T,
    "message": "ok"
  }
  ```
- **分页响应**: `PageResult<T>`
  ```java
  {
    "items": List<T>,
    "total": 100,
    "page": 1,
    "pageSize": 20
  }
  ```

#### 数据库操作

- **使用 MyBatis Plus**:
  - `LambdaQueryWrapper` - 类型安全的查询条件
  - `Page<T>` - 分页查询
  - `@TableLogic` - 逻辑删除（自动过滤 deleted=1）
- **事务管理**:
  - `@Transactional(rollbackFor = Exception.class)` - 异常回滚

#### 参数校验

- **分组校验**: 使用 `@Validated(RoleDTO.Create.class)` 区分创建和更新
- **自定义校验消息**: `@NotBlank(message = "角色名称不能为空")`

#### 时间处理

- **时区设置**: `Asia/Shanghai`
- **时间类型**: `LocalDateTime`、`LocalDate`
- **格式化**: `@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "Asia/Shanghai")`

### 5. 配置特点

#### 字符编码

- **数据库**: `utf8mb4`
- **JVM**: `-Dfile.encoding=UTF-8`
- **Tomcat**: `uri-encoding: UTF-8`
- **连接初始化**: `SET time_zone = '+08:00'`

#### 逻辑删除

- **全局配置**: `logic-delete-field: deleted`
- **删除值**: `1`
- **未删除值**: `0`

#### 分页配置

- **最大限制**: 1000 条/页
- **默认分页**: 20 条/页

---

## ⚙️ 实现功能点

### 1. 认证授权模块

#### 登录认证

- ✅ **用户登录** (`POST /auth/login`)
  - 用户名密码验证
  - BCrypt 密码加密
  - JWT Token 生成
  - 用户状态检查（启用/禁用）
  - 逻辑删除检查

- ✅ **退出登录** (`POST /auth/logout`)
  - Token 失效（可扩展黑名单机制）

- ✅ **刷新 Token** (`POST /auth/refresh`)
  - RefreshToken 验证
  - 生成新的 AccessToken

- ✅ **获取权限码** (`GET /auth/codes`)
  - 获取当前用户的权限码列表

#### 安全配置

- ✅ **JWT 过滤器**: `JwtAuthenticationFilter`
  - 请求头 Token 解析
  - Token 验证
  - 用户信息注入 SecurityContext

- ✅ **白名单配置**:
  - `/auth/login` - 登录
  - `/auth/logout` - 退出
  - `/auth/refresh` - 刷新 Token
  - `/test/**` - 测试接口
  - `/doc.html` - API 文档
  - `/v3/api-docs/**` - Swagger 文档

- ✅ **CORS 跨域配置**:
  - 允许所有域名（开发环境）
  - 允许所有请求方法和请求头
  - 允许携带凭证

### 2. 用户管理模块

- ✅ **获取用户信息** (`GET /user/info`)
  - 当前登录用户信息
  - 用户角色列表
  - 用户首页路径

### 3. 角色管理模块

- ✅ **角色列表** (`GET /system/role/list`)
  - 分页查询
  - 多条件搜索（名称、ID、备注、状态）
  - 时间范围查询（创建时间）
  - 排序（按创建时间倒序）

- ✅ **创建角色** (`POST /system/role`)
  - 角色名称校验（分组校验）
  - 权限关联（菜单ID列表）
  - 状态设置

- ✅ **更新角色** (`PUT /system/role/{id}`)
  - 部分更新（只更新非空字段）
  - 分组校验（更新时名称可选）
  - 权限关联更新

- ✅ **删除角色** (`DELETE /system/role/{id}`)
  - 逻辑删除
  - 检查用户关联

### 4. 菜单管理模块

- ✅ **菜单列表** (`GET /system/menu/list`)
  - 树形结构返回
  - 状态过滤
  - 排序（按 sort_order）

- ✅ **获取所有菜单** (`GET /menu/all`)
  - 用于前端路由生成
  - 树形结构
  - 只返回启用状态的菜单

- ✅ **创建菜单** (`POST /system/menu`)
  - 菜单类型（catalog/menu/button）
  - 路径唯一性检查
  - 名称唯一性检查
  - Meta 信息（JSON 格式）

- ✅ **更新菜单** (`PUT /system/menu/{id}`)
  - 路径唯一性检查（排除自己）
  - 名称唯一性检查（排除自己）

- ✅ **删除菜单** (`DELETE /system/menu/{id}`)
  - 逻辑删除
  - 检查子菜单

- ✅ **名称/路径存在性检查** (`GET /system/menu/name-exists`, `/path-exists`)
  - 用于前端实时校验

### 5. 部门管理模块

- ✅ **部门列表** (`GET /system/dept/list`)
  - 树形结构返回
  - 包含创建时间

- ✅ **创建部门** (`POST /system/dept`)
  - 名称唯一性检查（逻辑删除后允许重用）
  - 父级部门设置
  - 状态设置

- ✅ **更新部门** (`PUT /system/dept/{id}`)
  - 名称唯一性检查（排除自己）
  - 父级部门更新

- ✅ **删除部门** (`DELETE /system/dept/{id}`)
  - 逻辑删除
  - 检查子部门

- ✅ **名称存在性检查** (`GET /system/dept/name-exists`)
  - 用于前端实时校验

### 6. 权限管理模块

#### 权限模型

- ✅ **RBAC 模型**:
  - 用户（User）↔ 角色（Role）: 多对多
  - 角色（Role）↔ 菜单（Menu）: 多对多
  - 用户（User）↔ 权限（Permission）: 多对多（直接权限）

#### 权限码

- ✅ **权限码系统**:
  - 菜单权限码（如 `system:user:view`）
  - 按钮权限码（如 `system:user:add`）
  - 用户权限码查询

### 7. 数据库设计

#### 核心表结构

- ✅ **sys_user** - 用户表
  - 逻辑删除
  - 状态管理（启用/禁用）
  - 密码加密（BCrypt）

- ✅ **sys_role** - 角色表
  - 状态管理
  - 备注信息

- ✅ **sys_menu** - 菜单表
  - 树形结构（pid）
  - 菜单类型（catalog/menu/button）
  - Meta 信息（JSON）
  - 排序字段（sort_order，避免 MySQL 保留关键字）

- ✅ **sys_dept** - 部门表
  - 树形结构（pid）
  - 名称唯一性（函数索引，支持逻辑删除后重用）

- ✅ **sys_permission** - 权限表
  - 权限码（code）
  - 权限类型（menu/button）

- ✅ **关联表**:
  - `sys_user_role` - 用户角色关联
  - `sys_role_menu` - 角色菜单关联
  - `sys_user_permission` - 用户权限关联（直接权限）

#### 数据库特性

- ✅ **逻辑删除**: 所有表支持 `deleted` 字段
- ✅ **自动时间戳**: `create_time`、`update_time`
- ✅ **字符集**: `utf8mb4`（支持 emoji）
- ✅ **时区**: `Asia/Shanghai`（+08:00）
- ✅ **唯一约束**: 支持逻辑删除后的名称重用（函数索引）

### 8. 核心功能

#### 异常处理

- ✅ **全局异常处理**: `GlobalExceptionHandler`
  - 业务异常（BusinessException）
  - 参数校验异常（MethodArgumentNotValidException）
  - 认证异常（AuthenticationException）
  - 权限异常（AccessDeniedException）
  - 404 异常（NoHandlerFoundException）
  - 405 异常（HttpRequestMethodNotSupportedException）
  - 413 异常（MaxUploadSizeExceededException）
  - 通用异常（Exception）

#### 工具类

- ✅ **JwtUtils**: JWT Token 生成和验证
- ✅ **SecurityUtils**: 获取当前用户信息
- ✅ **FieldFillHandler**: 自动填充创建时间和更新时间

#### 配置类

- ✅ **SecurityConfiguration**: Spring Security 配置
- ✅ **MybatisPlusConfig**: MyBatis Plus 配置（分页插件）
- ✅ **Knife4jConfig**: Swagger 文档配置
- ✅ **CorsConfig**: 跨域配置

### 9. API 文档

- ✅ **Knife4j (Swagger)**:
  - 在线 API 文档：`http://localhost:8080/doc.html`
  - 接口分组（Tag）
  - 参数说明（Operation）
  - 请求/响应示例

### 10. 开发特性

#### 编码规范

- ✅ **统一响应格式**: `BaseResult<T>`
- ✅ **统一异常处理**: `GlobalExceptionHandler`
- ✅ **统一参数校验**: Bean Validation
- ✅ **统一分页**: `PageResult<T>`

#### 数据安全

- ✅ **密码加密**: BCrypt
- ✅ **JWT Token**: 无状态认证
- ✅ **逻辑删除**: 数据不物理删除
- ✅ **SQL 注入防护**: MyBatis Plus 参数化查询

#### 性能优化

- ✅ **连接池**: Druid 连接池管理
- ✅ **分页查询**: MyBatis Plus 分页插件
- ✅ **索引优化**: 数据库索引设计

---

## 📊 统计信息

### 代码规模

- **Controller**: 7 个
- **Service**: 4 个接口 + 4 个实现
- **Mapper**: 7 个
- **Entity**: 7 个
- **DTO**: 4 个
- **VO**: 5 个
- **配置类**: 5 个
- **工具类**: 3 个

### 注解使用统计

- `@RequiredArgsConstructor`: 高频使用（依赖注入）
- `@Data`: 所有实体类、DTO、VO
- `@Transactional`: 所有写操作（create/update/delete）
- `@Valid` / `@Validated`: 所有 Controller 参数校验
- `@TableLogic`: 所有实体类（逻辑删除）

---

## 🎯 设计亮点

1. **分层清晰**: Controller → Service → Mapper，职责明确
2. **统一响应**: `BaseResult<T>` 统一 API 响应格式
3. **异常处理**: 全局异常处理，统一错误响应
4. **参数校验**: Bean Validation + 分组校验，支持创建/更新不同规则
5. **逻辑删除**: 所有表支持逻辑删除，数据安全
6. **树形结构**: 菜单和部门支持树形结构，便于前端展示
7. **权限模型**: RBAC + 直接权限，灵活的权限控制
8. **JWT 认证**: 无状态认证，支持分布式部署
9. **API 文档**: Knife4j 集成，开发友好
10. **字符编码**: 全面 UTF-8 支持，解决中文乱码问题

---

## 📝 总结

这是一个**标准的企业级 Spring Boot 后端服务**，采用**分层架构**和**RESTful API 设计**，实现了完整的**用户、角色、菜单、部门管理**功能，支持**RBAC 权限模型**和**JWT 认证**。代码风格**规范统一**，使用了**Lombok**简化代码，**MyBatis Plus**简化数据库操作，**全局异常处理**统一错误响应，是一个**生产可用**的后端服务项目。
